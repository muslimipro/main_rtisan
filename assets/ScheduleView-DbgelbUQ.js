import{H as Y,b as fe,u as he,z as xe,r as c,f as J,ad as ye,a as F,C as be,o as n,c as o,i as s,t as l,h as v,F as f,k as x,n as A,j as y,Z as K,p as D,D as we,a0 as T,bv as ke,a_ as V}from"./index-BsDe7Jd6.js";import{T as Q}from"./teacherApi-CxfJjbuj.js";async function P(){const{data:b}=await Y.get("/v2/booking");return b??[]}async function De(b){return Y.post("/v2/booking",b)}async function Se(b){return Y.delete(`/v2/booking/${b}`)}const Ce={class:"p-6"},$e={class:"text-2xl font-bold mb-4"},Me={class:"flex items-center justify-center gap-4 mb-4"},Ee={class:"font-semibold text-lg"},Le={class:"max-w-6xl mx-auto flex flex-col items-center"},Te={class:"overflow-x-auto w-full"},Be={class:"min-w-full border text-center"},Fe={class:"flex flex-col items-center gap-1"},Ve={class:"text-xs text-slate-500 flex items-center gap-1"},We={class:"border px-2 py-1 font-semibold bg-slate-50"},He={key:0,class:"text-gray-400"},Ne={key:0},ze={class:"text-xs font-bold flex items-center"},Ue=["onClick"],je={key:0,class:"mt-1 w-full"},qe={class:"block text-xs text-emerald-700"},Ae={class:"text-xs text-emerald-700 font-semibold"},Pe=["onClick"],Ye={key:0},Oe={key:1,class:"text-xs text-gray-400"},Re=["onClick"],Ie={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40"},Ze={class:"bg-white rounded-lg shadow-lg p-6 w-full max-w-md relative"},Ge={class:"text-xl font-bold mb-4"},Je={class:"flex flex-col gap-2"},Ke={key:0,class:"text-gray-400"},Qe={key:1},Xe={value:void 0},et=["value"],tt={class:"flex flex-col gap-2"},at={class:"min-w-full border text-center"},st=["onClick"],lt={class:"flex flex-col items-center gap-1"},nt={key:0,class:"flex flex-row gap-2"},ot={class:"flex gap-2"},rt={class:"flex-1"},ut={class:"flex-1"},dt={class:"flex gap-2 mt-2"},it=["disabled"],ct={key:2,class:"text-red-500"},vt={key:3,class:"text-red-500"},X=15,_t=fe({__name:"ScheduleView",setup(b){const S=he(),ee=xe(),C=c([]),W=c(!1),m=c([]);J(async()=>{var a,t;W.value=!0;try{if(C.value=await P(),!w.value.length){const{data:e}=await Q.getClasses();w.value=e}}catch(e){S.add({severity:"error",summary:((t=(a=e==null?void 0:e.response)==null?void 0:a.data)==null?void 0:t.error)||"Error",life:2e3})}finally{W.value=!1}});const{t:i}=ye(),te=F(()=>{const a=h.value[0].date,t=h.value[6].date,e=new Set;let r=null;if(C.value.forEach(g=>{const d=new Date(g.starts_at);if(d>=a&&d<=t){const p=M(g.starts_at);e.add(p),(!r||oe(g.ends_at,r))&&(r=g.ends_at)}}),e.size===0)e.add("09:00");else{const d=Array.from(e).sort()[0],[p,_]=d.split(":").map(Number),ge=_>0?p:p-1,me=Math.max(ge,0);if(e.add(`${me.toString().padStart(2,"0")}:00`),r){const _e=M(r);e.add(_e)}}return Array.from(e).sort()});function ae(a){const t=new Date(a),e=t.getDay(),r=t.getDate()-(e+6)%7;return new Date(t.setDate(r))}const $=c(ae(new Date));function O(a){const t=new Date($.value);t.setDate($.value.getDate()+a*7),$.value=t}function se(){O(-1)}function le(){O(1)}const h=F(()=>{const a=[];for(let t=0;t<7;t++){const e=new Date($.value);e.setDate($.value.getDate()+t),e.setHours(0,0,0,0),t===6&&e.setHours(23,59,59,999),a.push({date:e,label:i(`pages.schedule.weekDay${t+1}`),dateLabel:`${e.getDate().toString().padStart(2,"0")}.${(e.getMonth()+1).toString().padStart(2,"0")}`})}return a}),ne=F(()=>{const a=h.value[0].date,t=h.value[6].date;return`${a.getDate().toString().padStart(2,"0")}.${(a.getMonth()+1).toString().padStart(2,"0")} - ${t.getDate().toString().padStart(2,"0")}.${(t.getMonth()+1).toString().padStart(2,"0")}`});function H(a,t){const e=new Date(a);return e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate()}function R(a,t){return C.value.filter(e=>{const r=new Date(e.starts_at);return H(r,a)&&M(e.starts_at)===t})}function M(a){return new Date(a).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1})}function I(a){const t=new Date(a);return t.getHours()*60+t.getMinutes()}function oe(a,t){return I(a)>I(t)}const E=c(!1),u=c({}),N=c(!1),B=c(null),w=c([]),z=c(!1),U=c(null),k=c(null),j=c(null),re=F(()=>{if(!k.value)return i("pages.schedule.selectDay");const a=k.value;return`${a.getDate().toString().padStart(2,"0")}.${(a.getMonth()+1).toString().padStart(2,"0")}.${a.getFullYear()}`+(j.value!==null?`, ${j.value}:00`:"")});async function ue(a,t){var g,d;k.value=new Date(a);const[e,r]=t.split(":").map(Number);j.value=e,u.value.starts_at_time=t,u.value.ends_at_time=`${(e+1).toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`,u.value.max_count=X,u.value.class_id=void 0,E.value=!0,B.value=null,z.value=!0,U.value=null,m.value=[],u.value.repeat_weeks=0;try{const{data:p}=await Q.getClasses();w.value=p}catch(p){S.add({severity:"error",summary:((d=(g=p==null?void 0:p.response)==null?void 0:g.data)==null?void 0:d.error)||"Error",life:2e3})}finally{z.value=!1}}function de(){if(u.value.class_id){const a=w.value.find(t=>t.id===u.value.class_id);a&&(u.value.max_count=a.student_count)}else u.value.max_count=X}function Z(a,t){const[e,r]=t.split(":").map(Number);return new Date(a.getFullYear(),a.getMonth(),a.getDate(),e,r,0,0).toISOString()}async function ie(a){ee.require({message:i("pages.schedule.deleteBookingConfirm"),header:i("pages.teacher.confirmation"),icon:"pi pi-exclamation-triangle",rejectProps:{label:i("pages.teacher.cancel"),severity:"secondary",outlined:!0},acceptProps:{label:i("pages.teacher.delete"),severity:"danger"},accept:async()=>{var t,e;try{await Se(a),C.value=await P()}catch(r){S.add({severity:"error",summary:((e=(t=r==null?void 0:r.response)==null?void 0:t.data)==null?void 0:e.error)||"Error",life:2e3})}}})}async function ce(){var a,t;N.value=!0,B.value=null;try{if(!k.value)throw new Error("No day selected");const e={starts_at:Z(k.value,u.value.starts_at_time),ends_at:Z(k.value,u.value.ends_at_time),max_count:u.value.max_count,class_id:u.value.class_id||void 0,week_days:m.value.length?m.value:void 0,repeat_weeks:m.value.length?u.value.repeat_weeks:void 0};await De(e),E.value=!1,C.value=await P()}catch(e){S.add({severity:"error",summary:((t=(a=e==null?void 0:e.response)==null?void 0:a.data)==null?void 0:t.error)||"Error",life:2e3})}finally{N.value=!1}}const L=c(null),q=c({x:0,y:0});function ve(a,t){if(t.stopPropagation(),L.value===a)L.value=null;else{L.value=a;const e=t.target.getBoundingClientRect();q.value={x:e.left,y:e.bottom+5}}}function G(){L.value=null}J(()=>{document.addEventListener("click",G)}),be(()=>{document.removeEventListener("click",G)});function pe(a){m.value.includes(a)?m.value=m.value.filter(t=>t!==a):m.value.push(a)}return(a,t)=>(n(),o("div",Ce,[s("h2",$e,l(a.$t("pages.teacher.schedule")),1),s("div",Me,[s("button",{onClick:se,class:"px-3 py-1 rounded bg-slate-200 hover:bg-slate-300 text-sm"},l(v(i)("pages.schedule.prevWeek")),1),s("span",Ee,l(ne.value),1),s("button",{onClick:le,class:"px-3 py-1 rounded bg-slate-200 hover:bg-slate-300 text-sm"},l(v(i)("pages.schedule.nextWeek")),1)]),s("div",Le,[s("div",Te,[s("table",Be,[s("thead",null,[s("tr",null,[t[7]||(t[7]=s("th",{class:"border px-2 py-1 bg-slate-100"},null,-1)),(n(!0),o(f,null,x(h.value,(e,r)=>(n(),o("th",{key:r,class:A(["border px-2 py-1",H(e.date,new Date)?"bg-green-100":"bg-slate-100"])},[s("div",Fe,[s("div",null,l(e.label),1),s("div",Ve,l(e.dateLabel),1)])],2))),128))])]),s("tbody",null,[(n(!0),o(f,null,x(te.value,e=>(n(),o("tr",{key:e},[s("td",We,l(e),1),(n(!0),o(f,null,x(h.value,(r,g)=>(n(),o("td",{key:g,class:A(["border px-1 py-1 min-w-[120px]",H(r.date,new Date)?"bg-green-50":""])},[W.value?(n(),o("div",He)):(n(),o(f,{key:1},[R(r.date,e).length?(n(),o("div",Ne,[(n(!0),o(f,null,x(R(r.date,e),d=>{var p;return n(),o("div",{key:d.id,class:"mb-1 p-1 rounded bg-emerald-100 border border-emerald-300 flex flex-col items-start justify-between relative"},[s("span",ze,[y(l(M(d.starts_at))+"-"+l(M(d.ends_at))+" ("+l(d.count)+"/"+l(d.max_count)+") ",1),s("button",{onClick:K(_=>ve(d.id,_),["stop"]),class:"ml-1 text-emerald-700 hover:text-emerald-900",title:"ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑƒÑ‡ÐµÐ½Ð¸ÐºÐ¾Ð²"}," ðŸ‘¥ ",8,Ue)]),d.class_id?(n(),o("div",je,[s("span",qe,l(v(i)("pages.schedule.fixedLesson")),1),s("span",Ae,l(((p=w.value.find(_=>_.id===d.class_id))==null?void 0:p.name)||""),1)])):D("",!0),s("button",{onClick:K(_=>ie(d.id),["stop"]),class:"absolute right-1 text-red-700 hover:text-red-900"},"ðŸ—‘",8,Pe),L.value===d.id?(n(),o("div",{key:1,class:"fixed z-50 bg-white border rounded shadow-lg min-w-[180px] p-2 max-h-40 overflow-y-auto",style:we({left:q.value.x+"px",top:q.value.y+"px"})},[d.students&&d.students.length?(n(),o("div",Ye,[(n(!0),o(f,null,x(d.students,_=>(n(),o("div",{key:_,class:"text-xs py-0.5 text-left"},l(_),1))),128))])):(n(),o("div",Oe,l(v(i)("pages.schedule.noStudents")),1))],4)):D("",!0)])}),128))])):(n(),o("button",{key:1,onClick:d=>ue(r.date,e),class:"text-emerald-600 hover:underline text-xs"},"+",8,Re))],64))],2))),128))]))),128))])])])]),E.value?(n(),o("div",Ie,[s("div",Ze,[s("button",{onClick:t[0]||(t[0]=e=>E.value=!1),class:"absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-xl"},"Ã—"),s("h3",Ge,l(v(i)("pages.schedule.newLesson"))+l(m.value.length?"":": "+re.value),1),s("div",Je,[z.value?(n(),o("div",Ke,l(v(i)("pages.schedule.loadingClasses")),1)):(n(),o("div",Qe,[s("label",null,[y(l(v(i)("pages.schedule.bookingClass"))+": ",1),T(s("select",{"onUpdate:modelValue":t[1]||(t[1]=e=>u.value.class_id=e),class:"border rounded p-1 w-full",onChange:de},[s("option",Xe,l(v(i)("pages.schedule.withoutClass")),1),(n(!0),o(f,null,x(w.value,e=>(n(),o("option",{key:e.id,value:e.id},l(e.name)+" ("+l(e.student_count)+")",9,et))),128))],544),[[ke,u.value.class_id,void 0,{number:!0}]])])])),s("div",tt,[s("table",at,[s("tbody",null,[s("tr",null,[(n(!0),o(f,null,x(h.value,(e,r)=>(n(),o("td",{key:r,class:A(["border px-2 py-1 cursor-pointer",m.value.includes(r)?"bg-green-300":""]),onClick:g=>pe(r)},[s("div",lt,[s("div",null,l(e.label),1)])],10,st))),128))])])]),m.value.length?(n(),o("div",nt,[s("label",null,[y(l(v(i)("pages.schedule.repeatWeeks1"))+" ",1),T(s("input",{type:"number","onUpdate:modelValue":t[2]||(t[2]=e=>u.value.repeat_weeks=e),min:"0",max:"13",class:"border rounded p-1 w-10",required:""},null,512),[[V,u.value.repeat_weeks,void 0,{number:!0}]]),y(" "+l(v(i)("pages.schedule.repeatWeeks2")),1)])])):D("",!0)]),s("div",ot,[s("label",rt,[y(l(v(i)("pages.schedule.bookingStart"))+": ",1),T(s("input",{type:"time","onUpdate:modelValue":t[3]||(t[3]=e=>u.value.starts_at_time=e),class:"border rounded p-1 w-full",required:"",step:"60",placeholder:"08:00"},null,512),[[V,u.value.starts_at_time]])]),s("label",ut,[y(l(v(i)("pages.schedule.bookingEnd"))+": ",1),T(s("input",{type:"time","onUpdate:modelValue":t[4]||(t[4]=e=>u.value.ends_at_time=e),class:"border rounded p-1 w-full",required:"",step:"60",placeholder:"10:00"},null,512),[[V,u.value.ends_at_time]])])]),s("label",null,[y(l(v(i)("pages.schedule.seats"))+": ",1),T(s("input",{type:"number","onUpdate:modelValue":t[5]||(t[5]=e=>u.value.max_count=e),min:"1",class:"border rounded p-1 w-full",required:""},null,512),[[V,u.value.max_count,void 0,{number:!0}]])]),s("div",dt,[s("button",{type:"button",onClick:ce,disabled:N.value,class:"px-3 py-1 rounded bg-emerald-500 text-white hover:bg-emerald-600"},l(v(i)("pages.teacher.create")),9,it),s("button",{type:"button",onClick:t[6]||(t[6]=e=>E.value=!1),class:"px-3 py-1 rounded bg-slate-300 hover:bg-slate-400"},l(v(i)("pages.schedule.cancelBooking")),1)]),B.value?(n(),o("div",ct,l(B.value),1)):D("",!0),U.value?(n(),o("div",vt,l(U.value),1)):D("",!0)])])])):D("",!0)]))}});export{_t as default};
